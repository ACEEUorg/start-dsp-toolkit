name: Notify CMS Changes

on:
  push:
    branches: ["main"]

jobs:
  detect-cms-change:
    runs-on: ubuntu-latest
    outputs:
      is-cms-commit: ${{ steps.detect.outputs.is-cms-commit }}
      commit-message: ${{ steps.detect.outputs.commit-message }}
      changed-files: ${{ steps.detect.outputs.changed-files }}
      tool-name: ${{ steps.detect.outputs.tool-name }}
      language: ${{ steps.detect.outputs.language }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect CMS commit
        id: detect
        run: |
          MESSAGE="${{ github.event.head_commit.message }}"
          AUTHOR="${{ github.event.head_commit.author.email }}"
          FILES=$(git diff --name-only HEAD~1 HEAD)
          
          echo "Commit message: $MESSAGE"
          echo "Changed files: $FILES"
          
          # Check if this is a CMS commit
          IS_CMS="false"
          TOOL_NAME=""
          LANGUAGE=""
          
          # Pattern 1: Commit message matches CMS pattern
          if [[ "$MESSAGE" =~ ^(Create|Update)\ Tool\ \(([^)]+)\)\ .+ ]]; then
            IS_CMS="true"
            LANGUAGE="${BASH_REMATCH[2]}"
            # Extract tool name from quotes
            if [[ "$MESSAGE" =~ .+"([^"]+)".* ]]; then
              TOOL_NAME="${BASH_REMATCH[1]}"
            fi
          fi
          
          # Pattern 2: Files changed are in content/tools directories
          if [[ "$FILES" =~ ^content/tools/ ]] && [[ "$IS_CMS" == "true" ]]; then
            echo "is-cms-commit=true" >> $GITHUB_OUTPUT
            echo "commit-message=$MESSAGE" >> $GITHUB_OUTPUT
            echo "changed-files=$FILES" >> $GITHUB_OUTPUT
            echo "tool-name=$TOOL_NAME" >> $GITHUB_OUTPUT
            echo "language=$LANGUAGE" >> $GITHUB_OUTPUT
          else
            echo "is-cms-commit=false" >> $GITHUB_OUTPUT
            echo "commit-message=$MESSAGE" >> $GITHUB_OUTPUT
            echo "changed-files=$FILES" >> $GITHUB_OUTPUT
          fi

  send-email-notification:
    if: needs.detect-cms-change.outputs.is-cms-commit == 'true'
    needs: detect-cms-change
    runs-on: ubuntu-latest
    steps:
      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.resend.com
          server_port: 587
          username: resend
          password: ${{ secrets.RESEND_API_KEY }}
          subject: "üìù CMS Update: ${{ needs.detect-cms-change.outputs.tool-name }} (${{ needs.detect-cms-change.outputs.language }})"
          to: meppen@aceeu.org
          from: notifications@resend.dev
          body: |
            üéØ **Decap CMS Content Update Detected**
            
            **Tool:** ${{ needs.detect-cms-change.outputs.tool-name }}
            **Language:** ${{ needs.detect-cms-change.outputs.language }}
            **Commit:** ${{ github.sha }}
            **Author:** ${{ github.event.head_commit.author.name }}
            
            **Commit Message:**
            ```
            ${{ needs.detect-cms-change.outputs.commit-message }}
            ```
            
            **Changed Files:**
            ```
            ${{ needs.detect-cms-change.outputs.changed-files }}
            ```
            
            **View Changes:** https://github.com/${{ github.repository }}/commit/${{ github.sha }}
            
            ---
            *This notification was sent automatically because a Decap CMS content update was detected.*